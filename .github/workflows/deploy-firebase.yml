name: Deploy Firebase

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "functions/**"
      - "firestore.rules"
      - ".firebaserc"
      - "firebase.json"

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GOOGLE_CLOUD_PROJECT: itziks-cart
      FIREBASE_PROJECT: itziks-cart
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Firebase CLI
        shell: bash
        run: npm i -g firebase-tools

      - name: Install Function Dependencies
        working-directory: functions
        shell: bash
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Validate Function Syntax
        shell: bash
        run: node --check functions/index.js

      - name: Setup GCP Service Account Credentials
        env:
          GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_APPLICATION_CREDENTIALS_JSON }}
        shell: bash
        run: |
          if [ -z "$GOOGLE_APPLICATION_CREDENTIALS_JSON" ]; then
            echo "Missing required GitHub secret: GOOGLE_APPLICATION_CREDENTIALS_JSON"
            echo "Add Firebase service-account JSON in repo secrets and rerun."
            exit 1
          fi

          printf '%s' "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > "$RUNNER_TEMP/gcp.json"
          export GOOGLE_APPLICATION_CREDENTIALS="$RUNNER_TEMP/gcp.json"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$RUNNER_TEMP/gcp.json" >> "$GITHUB_ENV"

      - name: Firebase Auth Check
        shell: bash
        run: |
          echo "firebase-tools version:"
          firebase --version
          echo "Checking Firebase auth and visible projects..."
          if ! firebase projects:list --non-interactive; then
            echo "Firebase authentication failed in CI."
            echo "Verify GOOGLE_APPLICATION_CREDENTIALS_JSON secret is valid service-account JSON for project itziks-cart."
            exit 1
          fi

      - name: Deploy Functions and Firestore Rules
        shell: bash
        run: |
          echo "Deploying Firebase functions + Firestore rules to project itziks-cart..."
          firebase deploy --project itziks-cart --only functions,firestore:rules --non-interactive
