rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /orders/{orderId} {
      function smsFieldsMissingOnCreate() {
        return !('smsStatus' in request.resource.data)
          && !('smsError' in request.resource.data)
          && !('smsSentAt' in request.resource.data);
      }

      function smsFieldsUnchangedOnUpdate() {
        return request.resource.data.smsStatus == resource.data.smsStatus
          && request.resource.data.smsError == resource.data.smsError
          && request.resource.data.smsSentAt == resource.data.smsSentAt;
      }

      // Demo-only security model:
      // - Customer and admin currently run without Firebase Auth.
      // - PIN gate is client-side only and is NOT a secure backend control.
      // TODO: replace with Firebase Auth + custom claims and tighten all rules.

      // Customer flow: create order documents.
      allow create: if smsFieldsMissingOnCreate();

      // Required for live customer status page + admin board.
      allow read: if true;

      // Client-side updates are allowed for existing behavior, but SMS delivery fields
      // are write-protected for Cloud Functions-only updates.
      allow update: if smsFieldsUnchangedOnUpdate();

      // Required for admin delete tools.
      allow delete: if true;

      // Future production rule (recommended):
      // allow read, update, delete: if request.auth != null
      //   && request.auth.token.admin == true;

      match /messages/{messageId} {
        // Demo-only security:
        // Without Firebase Auth, this remains permissive for the current project.
        // TODO: enforce authenticated customer/admin access in production.
        allow read: if true;
        allow create: if true;
        allow update: if true;
      }
    }
  }
}
