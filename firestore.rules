rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /orders/{orderId} {
      function smsFieldsMissingOnCreate() {
        return !('smsSent' in request.resource.data)
          && !('smsStatus' in request.resource.data)
          && !('smsError' in request.resource.data)
          && !('smsSentAt' in request.resource.data);
      }

      function smsFieldsUnchangedOnUpdate() {
        return request.resource.data.smsSent == resource.data.smsSent
          && request.resource.data.smsStatus == resource.data.smsStatus
          && request.resource.data.smsError == resource.data.smsError
          && request.resource.data.smsSentAt == resource.data.smsSentAt;
      }

      // Demo-only security model:
      // - Customer and admin currently run without Firebase Auth.
      // - PIN gate is client-side only and is NOT a secure backend control.
      // TODO: replace with Firebase Auth + custom claims and tighten all rules.

      // Customer flow: create order documents.
      allow create: if smsFieldsMissingOnCreate();

      // Required for live customer status page + admin board.
      allow read: if true;

      // Client-side updates are allowed for existing behavior, but SMS delivery fields
      // are write-protected for Cloud Functions-only updates.
      allow update: if smsFieldsUnchangedOnUpdate();

      // Required for admin delete tools.
      allow delete: if true;

      // Future production rule (recommended):
      // allow read, update, delete: if request.auth != null
      //   && request.auth.token.admin == true;

      match /messages/{messageId} {
        // Demo-only security:
        // Without Firebase Auth, this remains permissive for the current project.
        // TODO: enforce authenticated customer/admin access in production.
        allow read: if true;
        allow create: if true;
        allow update: if true;
      }
    }

    match /chats/{chatId} {
      function validDeviceId(deviceId) {
        return deviceId is string
          && deviceId.size() >= 8
          && deviceId.size() <= 200;
      }

      function isValidChatCreate() {
        return validDeviceId(request.resource.data.customerDeviceId)
          && request.resource.data.customerName is string
          && request.resource.data.customerPhone is string
          && request.resource.data.status in ['open', 'closed']
          && request.resource.data.unreadForAdmin is number
          && request.resource.data.unreadForCustomer is number;
      }

      function customerDeviceMatchesExistingChat() {
        return validDeviceId(resource.data.customerDeviceId)
          && request.resource.data.customerDeviceId == resource.data.customerDeviceId;
      }

      // Demo compromise:
      // - Customer write access is constrained by matching customerDeviceId.
      // - Admin dashboard is PIN-only on client side, so reads/writes stay open.
      // Production note: use Firebase Auth for real admin security.
      allow create: if isValidChatCreate();
      allow get, list: if true;
      allow update: if customerDeviceMatchesExistingChat() || request.auth == null;
      allow delete: if true;

      match /messages/{messageId} {
        function parentChat() {
          return get(/databases/$(database)/documents/chats/$(chatId));
        }

        function customerMessageMatchesParent() {
          return request.resource.data.sender == 'customer'
            && request.resource.data.customerDeviceId is string
            && request.resource.data.customerDeviceId == parentChat().data.customerDeviceId;
        }

        function adminMessageAllowed() {
          return request.resource.data.sender == 'admin';
        }

        function baseMessageFieldsValid() {
          return request.resource.data.text is string
            && request.resource.data.text.size() > 0
            && request.resource.data.text.size() <= 1000
            && request.resource.data.delivered == true;
        }

        // Demo-only: keeps customer device matching checks where possible,
        // while still allowing admin panel realtime access without Firebase Auth.
        allow read: if true;
        allow create: if baseMessageFieldsValid()
          && (customerMessageMatchesParent() || adminMessageAllowed());
        allow update: if true;
      }
    }
  }
}
